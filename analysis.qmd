---
format:
  html:
    toc: true
    toc-depth: 4
    page-layout: full
---

# Analysis

"Our goal is to define the top 20% of all Hubbard Hall donors from the past 11 years (I think that was how far back we said this went) and then also from the past 5 years.

We are looking for contact family name, total giving all time, last gift date, last FY total giving amount, and for the top 20% a breakdown of what their gift categories were (we want a complete donor profile, so for each donor we want to see the total contribution amount that includes donations, class purchases, ticket buys, etc.)

We have a couple of questions for Judy additionally, that may be answered after Don has a go. Namely, we are looking for where Sue's donations from Opus live, and also where Kathy Rhoome's donations live to make sure that donations like these are included in the total.  Also, we want to find out if there is a way to link businesses who give to individuals who exist in the database as a soft credit?  This doesn't apply to all businesses, but for example, is MSK linked to Jason in a way where you can pull total giving for an individual and see his corporate contributions as well?"


## Setup

```{r}
#| label: setup

source(here::here("libraries.R"))

hhdr <- here::here("data-raw")
neon <- fs::path(hhdr, "neon")
judy <- fs::path(hhdr, "judy")
rds <- fs::path(hhdr, "rds")

```

## Retrieve prepared data

```{r}
#| label: get-data

linkages <- readRDS(fs::path(rds, "linkages.rds"))
accounts <- readRDS(fs::path(rds, "accounts.rds"))
donations <- readRDS(fs::path(rds, "donations.rds"))
events <- readRDS(fs::path(rds, "events.rds"))
registrations <- readRDS(fs::path(rds, "registrations.rds"))

```

## Analysis

Our goal is to define the top 20% of all Hubbard Hall donors from the past 11 years (I think that was how far back we said this went) and then also from the past 5 years.

We are looking for contact family name, total giving all time, last gift date, last FY total giving amount, and for the top 20% a breakdown of what their gift categories were (we want a complete donor profile, so for each donor we want to see the total contribution amount that includes donations, class purchases, ticket buys, etc.)


### Top 20% all years


```{r}

glimpse(donations)
ns(donations)
skim(donations)
count(donations, account_type)
count(donations, tender_type)
count(donations, donation_type)
count(donations, donation_status)
count(donations, payment_status)

count(donations, fund)
count(donations, purpose)
# count(donations, source) # prob not needed

don1 <- donations |>
  filter(account_type == "Individual", donation_type == "DONATION", donation_status == "SUCCEEDED", payment_status == "SUCCEEDED") |>
  filter(accountid != "36805") |> # cash and miscellaneous credit card transactions
  select(id, name, group, hhid, hhname, accountid, fullname, donation_date, donation) |> # campaign, fund, purpose
  mutate(hhfy = ifelse(month(donation_date) >= 7, year(donation_date) + 1, year(donation_date)))
skim(don1)

# group by hh and hhfy
donfy <- don1 |>
  summarise(donation = sum(donation), .by = c(id, name, hhfy))

donsums <- donfy |>
  summarise(
    total = sum(donation),
    before_2021 = sum(donation * (hhfy < 2021)),
    since_2021 = sum(donation * (hhfy >= 2021)),
    .by = c(hhid, hhname)
  )

donfywide <- donfy |>
  pivot_wider(names_from = hhfy, values_from = donation, values_fill = 0)

donfinal <- donsums |>
  left_join(
    donfywide |>
      select(hhid, hhname, `2021`:`2026`),
    by = join_by(hhid, hhname)
  ) |>
  mutate(
    pct_total = total / sum(total),
    pct_2021plus = since_2021 / sum(since_2021)
  ) |>
  relocate(pct_total, pct_2021plus, .after = since_2021) |>
  arrange(desc(total))

donfinal

```

### Top 20% 5 years




## Quick plot: Household donor spending and performances, 2021 plus

```{r}
#| label: donations-events

glimpse(donations)
glimpse(registrations)

cashcc <- donations |> filter(accountid == "36805")
sum(cashcc$donation) # 26317.43

don1 <- donations |>
  rename(account_name = fullname) |>
  filter(account_type == "Individual", year(donation_date) >= 2021) |>
  filter(
    !str_detect(account_name, "Cash and Credit Card Miscellaneous Transactions")
  ) |>
  summarise(
    n = n(),
    donation = sum(donation, na.rm = TRUE),
    .by = c(id, name, group)
  ) |>
  filter(donation >= 15) |>
  arrange(desc(donation))

regs1 <- registrations |>
  filter(year(event_start_date) >= 2021) |>
  filter(str_detect(type, "Registrant"), event_status == "SUCCEEDED") |>
  select(id, name, group, hhid, hhname, accountid, account_name, amount)
skim(regs1)

regs2 <- regs1 |>
  summarise(amount = sum(amount, na.rm = TRUE), .by = c(id, name, group)) |>
  arrange(desc(amount))

#  acccount id	name 36805	Cash and Credit Card Miscellaneous Transactions in 2021 plus was 28 transactions, $3890, all donotcontact

regs1 |> filter(is.na(id))

comp <- don1 |>
  left_join(regs1, by = join_by(hhid, hhname)) |>
  mutate(amount = replace_na(amount, 0))
skim(comp)

comp |>
  ggplot(aes(donation, amount)) +
  geom_point()

comp |>
  ggplot(aes(amount, donation)) +
  geom_point()

comp |>
  filter(donation >= 5000, donation < 20000, amount < 2000) |>
  ggplot(aes(amount, donation)) +
  geom_point()

```

